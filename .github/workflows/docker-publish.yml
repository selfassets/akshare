name: Build and Publish Multi-Arch Docker Image (Organization)

on:
  push:
    branches: [ "oracle" ]        # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
    tags: [ "v*" ]              # æˆ–æ‰“ tag æ—¶è§¦å‘
  workflow_dispatch:             # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build:
    # ä»…å½“æ»¡è¶³ä»»æ„æ¡ä»¶æ—¶æ‰è¿è¡Œï¼š
    # 1) æ¨é€çš„æ˜¯ tagï¼ˆrefs/tags/*ï¼‰
    # 2) æœ€è¿‘ä¸€æ¬¡æäº¤ä¿¡æ¯åŒ…å«å…³é”®å­— "release"
    # 3) æ‰‹åŠ¨è§¦å‘ workflow_dispatchï¼ˆä¿ç•™æ‰‹åŠ¨è§¦å‘èƒ½åŠ›ï¼‰
    if: ${{ startsWith(github.ref, 'refs/tags/') || contains(github.event.head_commit.message, 'release') || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout source
        uses: actions/checkout@v4

      # 2. ç™»å½• GitHub Container Registry
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # 3. è®¾ç½® QEMU æ”¯æŒä¸åŒæ¶æ„ï¼ˆè®© x86_64 æ„å»º arm64 é•œåƒï¼‰
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 4. è®¾ç½® Buildx æ„å»ºå™¨
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5. æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒ
      - name: Build and push multi-arch image
        uses: docker/build-push-action@v6
        with:
          push: true
#          platforms: linux/arm64
          platforms: linux/amd64,linux/arm64   # ğŸ‘ˆ æ”¯æŒåŒæ¶æ„
          tags: |
            ghcr.io/selfassets/akshare:latest
            ghcr.io/selfassets/akshare:${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

